<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מערכת תכנון משימה אווירית מתקדמת</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- SunCalc -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">

    <style>
        /* Minimal utility classes inspired by Tailwind for production use */
        :root {
            --blue-50: #eff6ff;
            --blue-100: #dbeafe;
            --blue-400: #60a5fa;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --blue-700: #1d4ed8;
            --blue-800: #1e40af;
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            --purple-50: #faf5ff;
            --purple-100: #f3e8ff;
            --purple-200: #e9d5ff;
            --purple-600: #9333ea;
            --purple-800: #6b21a8;
            --orange-50: #fff7ed;
            --orange-100: #ffedd5;
            --orange-700: #c2410c;
            --yellow-50: #fefce8;
            --yellow-100: #fef9c3;
            --yellow-700: #a16207;
            --red-100: #fee2e2;
            --red-500: #ef4444;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --inner-shadow: inset 0 1px 3px 0 rgba(0,0,0,0.1);
        }

        /* Layout */
        .block { display: block; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .flex { display: flex; }
        .flex-1 { flex: 1 1 0%; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .shrink-0 { flex-shrink: 0; }
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }

        /* Positioning */
        .absolute { position: absolute; }
        .relative { position: relative; }
        .inset-0 { inset: 0; }
        .top-4 { top: 1rem; }
        .bottom-6 { bottom: 1.5rem; }
        .left-1/2 { left: 50%; }
        .right-4 { right: 1rem; }
        .z-20 { z-index: 20; }
        .z-[1000] { z-index: 1000; }
        .-translate-x-1/2 { transform: translateX(-50%); }
        .transform { transform: translateZ(0); }

        /* Spacing */
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-0.5 { padding-top: 0.125rem; padding-bottom: 0.125rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .space-y-1 > :not(:last-child) { margin-bottom: 0.25rem; }
        .space-y-2 > :not(:last-child) { margin-bottom: 0.5rem; }
        .space-y-3 > :not(:last-child) { margin-bottom: 0.75rem; }
        .space-y-4 > :not(:last-child) { margin-bottom: 1rem; }

        /* Sizing */
        .w-full { width: 100%; }
        .w-2 { width: 0.5rem; }
        .w-4 { width: 1rem; }
        .h-1 { height: 0.25rem; }
        .h-2 { height: 0.5rem; }
        .h-4 { height: 1rem; }
        .h-full { height: 100%; }
        .h-[50vh] { height: 50vh; }
        .max-h-40 { max-height: 10rem; }
        .md\:h-full { height: 100%; }
        .md\:w-[420px] { width: 420px; }

        /* Borders & Radius */
        .border { border: 1px solid #e2e8f0; }
        .border-2 { border-width: 2px; border-style: solid; }
        .border-t { border-top: 1px solid #e2e8f0; }
        .border-l { border-left: 1px solid #e2e8f0; }
        .border-white { border-color: #ffffff; }
        .border-white\/20 { border-color: rgba(255,255,255,0.2); }
        .border-blue-100 { border-color: var(--blue-100); }
        .border-gray-300 { border-color: var(--gray-300); }
        .border-orange-100 { border-color: var(--orange-100); }
        .border-purple-100 { border-color: var(--purple-100); }
        .border-purple-200 { border-color: var(--purple-200); }
        .border-red-100 { border-color: var(--red-100); }
        .border-slate-100 { border-color: var(--slate-100); }
        .border-slate-200 { border-color: var(--slate-200); }
        .border-yellow-100 { border-color: var(--yellow-100); }
        .rounded { border-radius: 0.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-full { border-radius: 9999px; }

        /* Backgrounds */
        .bg-white { background-color: #ffffff; }
        .bg-white\/10 { background-color: rgba(255,255,255,0.1); }
        .bg-white\/90 { background-color: rgba(255,255,255,0.9); }
        .bg-blue-50 { background-color: var(--blue-50); }
        .bg-blue-100 { background-color: var(--blue-100); }
        .bg-blue-500 { background-color: var(--blue-500); }
        .bg-blue-600 { background-color: var(--blue-600); }
        .bg-slate-50 { background-color: var(--slate-50); }
        .bg-slate-200 { background-color: var(--slate-200); }
        .bg-slate-900 { background-color: var(--slate-900); }
        .bg-purple-50 { background-color: var(--purple-50); }
        .bg-purple-600 { background-color: var(--purple-600); }
        .bg-orange-50 { background-color: var(--orange-50); }
        .bg-gray-200 { background-color: var(--gray-200); }
        .bg-yellow-50 { background-color: var(--yellow-50); }
        .bg-gradient-to-r { background-image: linear-gradient(to right, var(--from-color, #4f46e5), var(--to-color, #9333ea)); }
        .from-indigo-600 { --from-color: #4f46e5; }
        .from-slate-900 { --from-color: var(--slate-900); }
        .to-purple-600 { --to-color: var(--purple-600); }
        .to-slate-800 { --to-color: var(--slate-800); }

        /* Typography */
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-[10px] { font-size: 10px; }
        .text-[11px] { font-size: 11px; }
        .font-bold { font-weight: 700; }
        .font-black { font-weight: 900; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }
        .text-center { text-align: center; }
        .text-blue-400 { color: var(--blue-400); }
        .text-blue-600 { color: var(--blue-600); }
        .text-blue-700 { color: var(--blue-700); }
        .text-blue-800 { color: var(--blue-800); }
        .text-slate-400 { color: var(--slate-400); }
        .text-slate-500 { color: var(--slate-500); }
        .text-slate-600 { color: var(--slate-600); }
        .text-slate-700 { color: var(--slate-700); }
        .text-slate-800 { color: var(--slate-800); }
        .text-slate-900 { color: var(--slate-900); }
        .text-purple-600 { color: var(--purple-600); }
        .text-purple-800 { color: var(--purple-800); }
        .text-orange-700 { color: var(--orange-700); }
        .text-yellow-700 { color: var(--yellow-700); }
        .text-red-500 { color: var(--red-500); }
        .text-gray-400 { color: var(--gray-400); }
        .text-gray-500 { color: #6b7280; }
        .text-white { color: #ffffff; }
        .leading-relaxed { line-height: 1.625; }
        .tracking-wide { letter-spacing: 0.025em; }
        .tracking-wider { letter-spacing: 0.05em; }
        .uppercase { text-transform: uppercase; }
        .whitespace-nowrap { white-space: nowrap; }
        .whitespace-pre-line { white-space: pre-line; }

        /* Effects */
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .shadow-inner { box-shadow: var(--inner-shadow); }
        .backdrop-blur { backdrop-filter: blur(10px); }
        .transition { transition: all 150ms ease; }
        .transition-all { transition: all 200ms ease; }
        .hover\:shadow-md:hover { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .hover\:opacity-90:hover { opacity: 0.9; }
        .hover\:scale-110:hover { transform: scale(1.1); }
        .hover\:bg-blue-50:hover { background-color: var(--blue-50); }
        .hover\:bg-red-50:hover { background-color: #fef2f2; }
        .hover\:bg-slate-800:hover { background-color: #1e293b; }

        /* Rings and focus */
        .focus\:outline-none:focus { outline: none; }
        .focus\:ring-2:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); }
        .focus\:ring-blue-400:focus { box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.6); }
        .appearance-none { appearance: none; }

        /* Misc */
        .cursor-pointer { cursor: pointer; }
        .text-center { text-align: center; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .accent-blue-600 { accent-color: var(--blue-600); }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-bounce { animation: bounce 1s infinite; }
        .bg-white\/10 { background-color: rgba(255,255,255,0.1); }
        .bg-white\/90 { background-color: rgba(255,255,255,0.9); }
        .placeholder-white\/50::placeholder { color: rgba(255,255,255,0.5); }

        @media (min-width: 768px) {
            .md\:flex-row { flex-direction: row; }
            .md\:h-full { height: 100%; }
            .md\:w-[420px] { width: 420px; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8,0,1,1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0,0,0.2,1); }
        }

        /* Global Styles */
        html, body, #root { height: 100%; margin: 0; overflow: hidden; }
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        
        /* Map Styling */
        #map { height: 100%; width: 100%; min-height: 60vh; z-index: 0; }
        .leaflet-control-layers { border-radius: 8px !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important; border: none !important; }
        
        /* UI Components */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.5); }
        .input-field { width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-size: 0.875rem; transition: all 200ms ease; background-color: rgba(255,255,255,0.5); }
        .input-field:focus { outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); background-color: #ffffff; }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        
        /* Animations */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .user-marker-pulse { animation: pulse-ring 2s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- Drone Database (Expanded) ---
        const DRONE_PRESETS = {
            'mavic_3_e': { name: 'DJI Mavic 3 Enterprise', sensorWidth: 17.3, focalLength: 12.29, imageWidth: 5280, type: 'Survey' }, // 4/3 CMOS
            'matrice_30_t': { name: 'DJI Matrice 30T', sensorWidth: 6.4, focalLength: 4.5, imageWidth: 4000, type: 'Thermal/Inspection' }, // 1/2 CMOS
            'evo_ii_640t': { name: 'Autel Evo II Dual 640T V3', sensorWidth: 9.8, focalLength: 6, imageWidth: 4000, type: 'Thermal/Rescue' }, // .8" CMOS
            'mavic_mini_2': { name: 'DJI Mini 2/SE', sensorWidth: 6.17, focalLength: 4.49, imageWidth: 4000, type: 'Hobby' },
            'mavic_3_pro': { name: 'DJI Mavic 3 Pro', sensorWidth: 17.3, focalLength: 12.29, imageWidth: 5280, type: 'Cinema' },
        };

        // --- Icons Component ---
        const Icon = ({ name, size = 18, className = "" }) => {
            const icons = {
                menu: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
                map: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z"/><path d="M15 5.764v15"/><path d="M9 3.236v15"/></svg>,
                crosshair: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></svg>,
                drone: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"/><path d="M3.5 12h2.5"/><path d="M18 12h2.5"/><path d="M12 3.5v2.5"/><path d="M12 18v2.5"/><path d="M4 7l3 3"/><path d="M17 7l3 -3"/><path d="M4 17l3 -3"/><path d="M17 17l3 3"/></svg>,
                cloud: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17.5 19c0-1.7-1.3-3-3-3h-11a4 4 0 1 1 .9-7.9 13 13 0 0 1 24.2 2.6A6 6 0 0 1 17.5 19z"/></svg>,
                trash: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
                chevronDown: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>
            };
            return icons[name] || null;
        };

        // --- Accordion Component ---
        const Accordion = ({ title, icon, isOpen, onClick, children }) => (
            <div className="border border-slate-200 rounded-xl overflow-hidden mb-3 bg-white shadow-sm transition-all hover:shadow-md">
                <button 
                    onClick={onClick}
                    className={`w-full flex items-center justify-between p-4 text-right transition-colors ${isOpen ? 'bg-slate-50 text-blue-600' : 'text-slate-700'}`}
                >
                    <div className="flex items-center gap-3 font-bold text-sm">
                        <div className={`p-2 rounded-lg ${isOpen ? 'bg-blue-100' : 'bg-slate-100'}`}>
                            <Icon name={icon} size={18} />
                        </div>
                        {title}
                    </div>
                    <Icon name="chevronDown" size={16} className={`transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`} />
                </button>
                <div className={`transition-all duration-300 ease-in-out overflow-hidden ${isOpen ? 'max-h-[800px] opacity-100' : 'max-h-0 opacity-0'}`}>
                    <div className="p-4 border-t border-slate-100 text-sm">
                        {children}
                    </div>
                </div>
            </div>
        );

        const App = () => {
            // --- App State ---
            const [missionName, setMissionName] = useState(`משימה ${new Date().toLocaleDateString()}`);
            const [activeSection, setActiveSection] = useState('drone'); // 'drone', 'flight', 'weather', 'stats'
            const [mapCenter, setMapCenter] = useState(null);
            
            // Flight Params
            const [selectedDrone, setSelectedDrone] = useState('mavic_3_e');
            const [altitude, setAltitude] = useState(50);
            const [overlapFront, setOverlapFront] = useState(75);
            const [overlapSide, setOverlapSide] = useState(70);
            const [speed, setSpeed] = useState(10);
            const [azimuth, setAzimuth] = useState(0);
            const [flightDate, setFlightDate] = useState(new Date().toISOString().slice(0, 16));

            // Data
            const [weather, setWeather] = useState(null);

            // Map Data
            const [polygon, setPolygon] = useState([]);
            const [pathLength, setPathLength] = useState(0);
            const [dtmStats, setDtmStats] = useState(null);
            const [terrainProbe, setTerrainProbe] = useState({ lat: null, lng: null, elevation: null, source: null, loading: false, error: null });
            const mapRef = useRef(null);
            const layersRef = useRef({});
            const hoverDebounceRef = useRef(null);

            // --- Logic: Geolocation ---
            const locateUser = useCallback(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            const { latitude, longitude } = pos.coords;
                            setMapCenter([latitude, longitude]);
                            if (mapRef.current) {
                                mapRef.current.flyTo([latitude, longitude], 18, { duration: 1.5 });
                            }
                        },
                        (err) => alert("לא ניתן לאתר מיקום. ודא שה-GPS פעיל."),
                        { enableHighAccuracy: true }
                    );
                }
            }, []);

            // Init Geolocation
            useEffect(() => {
                locateUser();
            }, [locateUser]);

            // --- Logic: Weather ---
            const fetchWeather = async () => {
                if (!mapCenter) return;
                try {
                    const dateIso = new Date(flightDate).toISOString().slice(0, 13) + ":00";
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${mapCenter[0]}&longitude=${mapCenter[1]}&hourly=temperature_2m,precipitation_probability,cloudcover,windspeed_80m,winddirection_80m&forecast_days=3`;
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    const idx = data.hourly.time.findIndex(t => t === dateIso);
                    if (idx !== -1) {
                        setWeather({
                            temp: data.hourly.temperature_2m[idx],
                            rain: data.hourly.precipitation_probability[idx],
                            clouds: data.hourly.cloudcover[idx],
                            wind: data.hourly.windspeed_80m[idx],
                            windDir: data.hourly.winddirection_80m[idx]
                        });
                    }
                } catch (e) { console.error(e); }
            };

            // Auto fetch weather when location/time changes
            useEffect(() => { if(mapCenter) fetchWeather(); }, [mapCenter, flightDate]);

            // --- Logic: DTM (OpenTopoData) ---
            const fetchElevationsBatch = async (points) => {
                if (!points?.length) return null;
                const unique = Array.from(new Map(points.map(p => [`${p[0].toFixed(5)},${p[1].toFixed(5)}`, p])).values());
                const url = `https://api.opentopodata.org/v1/srtm90m?locations=${unique.map(p => `${p[0]},${p[1]}`).join('|')}`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    return data?.results?.map(r => r?.elevation).filter(e => typeof e === 'number');
                } catch (e) {
                    console.error('DTM batch fetch failed', e);
                    return null;
                }
            };

            const probeElevation = async (lat, lng, source = 'hover') => {
                setTerrainProbe({ lat, lng, elevation: terrainProbe?.elevation ?? null, source, loading: true, error: null });
                try {
                    const res = await fetch(`https://api.opentopodata.org/v1/srtm90m?locations=${lat},${lng}`);
                    const data = await res.json();
                    const elevation = data?.results?.[0]?.elevation ?? null;
                    setTerrainProbe({ lat, lng, elevation, source, loading: false, error: elevation === null ? 'נתוני DTM לא זמינים' : null });
                } catch (e) {
                    setTerrainProbe({ lat, lng, elevation: null, source, loading: false, error: 'שגיאת DTM' });
                }
            };

            const effectiveAltitude = useMemo(() => {
                const terrainDelta = dtmStats ? (dtmStats.max - dtmStats.min) : 0;
                return Math.max(5, altitude - terrainDelta);
            }, [altitude, dtmStats]);

            // --- Logic: Map & Path ---
            useEffect(() => {
                if (!mapRef.current && document.getElementById('map')) {
                    // Init Map with Layer Control
                    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' });
                    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });

                    mapRef.current = L.map('map', {
                        center: mapCenter || [32.08, 34.78],
                        zoom: 13,
                        layers: [osm], // Default layer
                        zoomControl: false // We'll add it elsewhere or leave mobile gestures
                    });

                    const baseMaps = { "מפה רגילה": osm, "תצלום אוויר": satellite };
                    L.control.layers(baseMaps).addTo(mapRef.current);

                    // Ensure the map draws correctly after layout changes
                    setTimeout(() => mapRef.current.invalidateSize(), 300);
                    const handleResize = () => mapRef.current.invalidateSize();
                    window.addEventListener('resize', handleResize);

                    // Event Listeners
                    mapRef.current.on('click', e => {
                        setPolygon(prev => [...prev, [e.latlng.lat, e.latlng.lng]]);
                        probeElevation(e.latlng.lat, e.latlng.lng, 'click');
                    });

                    mapRef.current.on('mousemove', e => {
                        if (hoverDebounceRef.current) clearTimeout(hoverDebounceRef.current);
                        hoverDebounceRef.current = setTimeout(() => {
                            probeElevation(e.latlng.lat, e.latlng.lng, 'hover');
                        }, 250);
                    });

                    return () => {
                        window.removeEventListener('resize', handleResize);
                    };
                }
            }, []);

            // DTM stats for polygon
            useEffect(() => {
                const updateDtmStats = async () => {
                    if (!polygon.length) { setDtmStats(null); return; }
                    const bounds = L.latLngBounds(polygon);
                    const samples = [...polygon, [bounds.getNorth(), bounds.getWest()], [bounds.getNorth(), bounds.getEast()], [bounds.getSouth(), bounds.getWest()], [bounds.getSouth(), bounds.getEast()], [bounds.getCenter().lat, bounds.getCenter().lng]];
                    const elevations = await fetchElevationsBatch(samples);
                    if (elevations && elevations.length) {
                        const min = Math.min(...elevations);
                        const max = Math.max(...elevations);
                        const avg = elevations.reduce((a, b) => a + b, 0) / elevations.length;
                        setDtmStats({ min, max, avg });
                    }
                };
                updateDtmStats();
            }, [polygon]);

            // Draw Polygon & Path
            useEffect(() => {
                if (!mapRef.current) return;
                
                // Cleanup
                if (layersRef.current.poly) mapRef.current.removeLayer(layersRef.current.poly);
                if (layersRef.current.path) mapRef.current.removeLayer(layersRef.current.path);
                
                if (polygon.length > 0) {
                    // Draw Polygon
                    layersRef.current.poly = L.polygon(polygon, { color: '#ef4444', fillOpacity: 0.1 }).addTo(mapRef.current);
                    
                    // Draw Path (Snake) if > 2 points
                    if (polygon.length > 2) {
                        const drone = DRONE_PRESETS[selectedDrone];
                        const footprintW = (drone.sensorWidth * effectiveAltitude) / drone.focalLength;
                        const stripSpacing = footprintW * (1 - overlapSide / 100);
                        
                        // Simplified path gen logic for demo (bounding box based)
                        const bounds = L.latLngBounds(polygon);
                        const path = [];
                        // Roughly convert meters to degrees (very approx)
                        const step = stripSpacing / 111000; 
                        
                        let currLat = bounds.getNorth();
                        let dir = 1;
                        let len = 0;

                        while(currLat > bounds.getSouth()) {
                            const p1 = L.latLng(currLat, bounds.getWest());
                            const p2 = L.latLng(currLat, bounds.getEast());
                            if(dir === 1) { path.push(p1, p2); } else { path.push(p2, p1); }
                            len += p1.distanceTo(p2);
                            currLat -= step;
                            dir *= -1;
                        }
                        
                        layersRef.current.path = L.polyline(path, { color: '#3b82f6', weight: 3 }).addTo(mapRef.current);
                        setPathLength(len);
                    }
                }
            }, [polygon, selectedDrone, overlapSide, effectiveAltitude]);

            // User Marker Update
            useEffect(() => {
                if(mapRef.current && mapCenter) {
                    if(layersRef.current.user) mapRef.current.removeLayer(layersRef.current.user);
                    const icon = L.divIcon({
                        html: `<div class="w-4 h-4 bg-blue-600 rounded-full border-2 border-white shadow-lg user-marker-pulse"></div>`,
                        className: 'bg-transparent',
                        iconSize: [16, 16]
                    });
                    layersRef.current.user = L.marker(mapCenter, {icon}).addTo(mapRef.current);
                }
            }, [mapCenter]);

            // --- Calculated Stats ---
            const stats = useMemo(() => {
                const d = DRONE_PRESETS[selectedDrone];
                const gsd = (d.sensorWidth * effectiveAltitude * 100) / (d.focalLength * d.imageWidth);
                const timeMin = Math.floor((pathLength / speed) / 60);
                return { gsd: gsd.toFixed(2), time: timeMin };
            }, [selectedDrone, effectiveAltitude, speed, pathLength]);

            return (
                <div className="flex flex-col md:flex-row h-full">
                    
                    {/* Sidebar Controls */}
                    <div className="w-full md:w-[420px] bg-white shadow-2xl z-20 flex flex-col h-[50vh] md:h-full border-l border-slate-200 relative">
                        
                        {/* Top Bar */}
                        <div className="p-4 bg-gradient-to-r from-slate-900 to-slate-800 text-white shadow-md shrink-0">
                            <div className="flex items-center justify-between mb-2">
                                <h1 className="text-lg font-black tracking-wide flex items-center gap-2">
                                    <Icon name="drone" className="text-blue-400" /> AERIAL PLANNER PRO
                                </h1>
                                <div className="text-[10px] bg-blue-600 px-2 py-0.5 rounded-full font-bold">V2.0</div>
                            </div>
                            <input 
                                type="text" 
                                value={missionName} 
                                onChange={e => setMissionName(e.target.value)}
                                className="w-full bg-white/10 border border-white/20 text-white placeholder-white/50 text-sm rounded px-2 py-1 focus:ring-2 focus:ring-blue-400 focus:outline-none text-center font-bold"
                            />
                        </div>

                        {/* Scrollable Sections */}
                        <div className="flex-1 overflow-y-auto p-3 custom-scroll bg-slate-50">
                            
                            {/* Section 1: Drone Selection */}
                            <Accordion
                                title="בחירת רחפן וציוד"
                                icon="drone"
                                isOpen={activeSection === 'drone'}
                                onClick={() => setActiveSection(activeSection === 'drone' ? '' : 'drone')}
                            >
                                <div className="space-y-4">
                                    <select
                                        value={selectedDrone}
                                        onChange={e => setSelectedDrone(e.target.value)}
                                        className="input-field font-bold text-slate-700"
                                    >
                                        {Object.entries(DRONE_PRESETS).map(([k, v]) => (
                                            <option key={k} value={k}>{v.name}</option>
                                        ))}
                                    </select>
                                    
                                    <div className="text-xs text-slate-500 bg-white p-2 rounded border">
                                        סוג: {DRONE_PRESETS[selectedDrone].type} | חיישן: {DRONE_PRESETS[selectedDrone].sensorWidth}mm
                                    </div>
                                </div>
                            </Accordion>

                            {/* Section 2: Weather */}
                            <Accordion
                                title="תנאי סביבה"
                                icon="cloud"
                                isOpen={activeSection === 'weather'}
                                onClick={() => setActiveSection(activeSection === 'weather' ? '' : 'weather')}
                            >
                                <div className="space-y-3">
                                    <input 
                                        type="datetime-local" 
                                        value={flightDate} 
                                        onChange={e => setFlightDate(e.target.value)}
                                        className="input-field"
                                    />
                                    
                                    {weather ? (
                                        <div className="grid grid-cols-3 gap-2 text-center text-xs">
                                            <div className="bg-blue-50 p-2 rounded border border-blue-100">
                                                <div className="font-bold text-blue-700">{weather.rain}%</div>
                                                <div className="text-slate-500">סיכוי גשם</div>
                                            </div>
                                            <div className="bg-orange-50 p-2 rounded border border-orange-100">
                                                <div className="font-bold text-orange-700">{weather.wind}</div>
                                                <div className="text-slate-500">רוח (80m)</div>
                                            </div>
                                            <div className="bg-yellow-50 p-2 rounded border border-yellow-100">
                                                <div className="font-bold text-yellow-700">{weather.clouds}%</div>
                                                <div className="text-slate-500">עננות</div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-xs text-center text-gray-400">טוען נתונים לפי מיקום המפה...</div>
                                    )}

                                    <div className="text-xs text-slate-600 bg-blue-50 border border-blue-100 rounded-lg p-3 leading-relaxed">
                                        הנתונים נטענים ישירות משירותי מזג האוויר לפי המיקום שבחרת על המפה. מומלץ לרענן את המידע לאחר שינוי מיקום או זמן הטיסה.
                                    </div>
                                </div>
                            </Accordion>

                            {/* Section 3: Flight Params */}
                            <Accordion
                                title="פרמטרים לטיסה"
                                icon="map"
                                isOpen={activeSection === 'flight'}
                                onClick={() => setActiveSection(activeSection === 'flight' ? '' : 'flight')}
                            >
                                <div className="space-y-4">
                                    <div>
                                        <div className="flex justify-between text-xs font-bold mb-1">
                                            <span>גובה טיסה (מטר)</span>
                                            <span className="text-blue-600">{altitude}</span>
                                        </div>
                                        <input type="range" min="10" max="200" value={altitude} onChange={e => setAltitude(Number(e.target.value))} className="w-full accent-blue-600 h-1 bg-gray-200 rounded appearance-none cursor-pointer"/>
                                    </div>
                                    
                                    <div>
                                        <div className="flex justify-between text-xs font-bold mb-1">
                                            <span>מהירות טיסה (מ/ש)</span>
                                            <span className="text-blue-600">{speed}</span>
                                        </div>
                                        <input type="range" min="2" max="20" value={speed} onChange={e => setSpeed(Number(e.target.value))} className="w-full accent-blue-600 h-1 bg-gray-200 rounded appearance-none cursor-pointer"/>
                                    </div>

                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-xs font-bold block mb-1">חפיפה קדמית</label>
                                            <input type="number" value={overlapFront} onChange={e => setOverlapFront(Number(e.target.value))} className="input-field text-center" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold block mb-1">חפיפה צידית</label>
                                            <input type="number" value={overlapSide} onChange={e => setOverlapSide(Number(e.target.value))} className="input-field text-center" />
                                        </div>
                                    </div>

                                    <div className="bg-blue-50 border border-blue-100 rounded-lg p-3 text-xs text-slate-700 space-y-2">
                                        <div className="flex items-center justify-between font-bold text-blue-800">
                                            <span>נתוני DTM (SRTM)</span>
                                            <span className="text-[10px]">OpenTopoData</span>
                                        </div>
                                        {dtmStats ? (
                                            <div className="grid grid-cols-3 gap-2 text-center">
                                                <div>
                                                    <div className="text-lg font-black text-slate-900">{dtmStats.min.toFixed(1)}</div>
                                                    <div className="text-[10px] text-slate-500">מינ׳ (מ')</div>
                                                </div>
                                                <div>
                                                    <div className="text-lg font-black text-blue-700">{dtmStats.avg.toFixed(1)}</div>
                                                    <div className="text-[10px] text-slate-500">ממוצע (מ')</div>
                                                </div>
                                                <div>
                                                    <div className="text-lg font-black text-slate-900">{dtmStats.max.toFixed(1)}</div>
                                                    <div className="text-[10px] text-slate-500">מקס׳ (מ')</div>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="text-slate-500">סמן אזור על המפה לקבלת גבהים.</div>
                                        )}
                                        <div className="bg-white rounded-lg border border-blue-100 p-2 text-[11px] flex items-center justify-between">
                                            <span>גובה עבודה מחושב (AGL):</span>
                                            <span className="font-black text-blue-700">{effectiveAltitude.toFixed(1)} מ'</span>
                                        </div>
                                    </div>
                                </div>
                            </Accordion>

                            {/* Live Stats Box */}
                            <div className="bg-white rounded-xl p-4 shadow-sm border border-slate-200 mt-2">
                                <h3 className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">סטטיסטיקות בזמן אמת</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="text-center border-l border-slate-100">
                                        <div className="text-2xl font-black text-slate-800">{stats.gsd}</div>
                                        <div className="text-[10px] text-slate-500">GSD (cm/px)</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-2xl font-black text-blue-600">{stats.time}</div>
                                        <div className="text-[10px] text-slate-500">זמן דקות (משוער)</div>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-xl p-4 shadow-sm border border-slate-200 mt-2 text-xs text-slate-700 space-y-1">
                                <div className="flex items-center justify-between">
                                    <span className="font-bold text-slate-800">קריאת XYZ מהמפה</span>
                                    <span className="text-[10px] text-slate-500">צבע כחול = Hover</span>
                                </div>
                                {terrainProbe.lat ? (
                                    <div className="grid grid-cols-2 gap-2">
                                        <div className="bg-slate-50 p-2 rounded border">
                                            <div className="text-[10px] text-slate-500">Lat</div>
                                            <div className="font-mono text-sm">{terrainProbe.lat.toFixed(6)}</div>
                                            <div className="text-[10px] text-slate-500 mt-1">Lng</div>
                                            <div className="font-mono text-sm">{terrainProbe.lng.toFixed(6)}</div>
                                        </div>
                                        <div className={`p-2 rounded border ${terrainProbe.source === 'hover' ? 'bg-blue-50 border-blue-200' : 'bg-slate-50'}`}>
                                            <div className="text-[10px] text-slate-500">גובה קרקע (מ')</div>
                                            <div className="font-black text-lg text-slate-900">
                                                {terrainProbe.loading ? '...'
                                                    : terrainProbe.elevation !== null ? terrainProbe.elevation.toFixed(1)
                                                    : 'N/A'}
                                            </div>
                                            <div className="text-[10px] text-slate-500 mt-1">מצב: {terrainProbe.source === 'click' ? 'קליק' : 'Hover'}</div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-slate-500">העבר את העכבר על המפה או לחץ לקבלת ערכי XYZ.</div>
                                )}
                                {terrainProbe.error && <div className="text-red-500 text-[11px]">{terrainProbe.error}</div>}
                            </div>
                        </div>

                        {/* Bottom Actions */}
                        <div className="p-3 bg-white border-t border-slate-200 flex gap-2 shrink-0">
                            <button onClick={() => setPolygon([])} className="p-2 text-red-500 border border-red-100 rounded-lg hover:bg-red-50">
                                <Icon name="trash" />
                            </button>
                            <button className="flex-1 bg-slate-900 text-white rounded-lg font-bold text-sm py-2 hover:bg-slate-800 transition shadow-lg">
                                ייצא תוכנית (KML/CSV)
                            </button>
                        </div>
                    </div>

                    {/* Map Area */}
                    <div className="flex-1 relative h-[50vh] md:h-full">
                        <div id="map" className="bg-slate-200"></div>

                        {terrainProbe.lat && (
                            <div className={`absolute top-4 right-4 z-[1000] bg-white/95 backdrop-blur rounded-xl shadow-lg border px-4 py-3 text-xs ${terrainProbe.source === 'hover' ? 'border-blue-200' : 'border-slate-200'}`}>
                                <div className="text-[10px] uppercase tracking-wide text-slate-500">{terrainProbe.source === 'click' ? 'נקודה נבחרת' : 'מעבר עכבר'}</div>
                                <div className="font-mono text-[11px] text-slate-700">Lat: {terrainProbe.lat.toFixed(6)}</div>
                                <div className="font-mono text-[11px] text-slate-700">Lng: {terrainProbe.lng.toFixed(6)}</div>
                                <div className="mt-1 font-black text-blue-700 text-sm">גובה DTM: {terrainProbe.elevation !== null ? `${terrainProbe.elevation.toFixed(1)} מ'` : 'N/A'}</div>
                            </div>
                        )}
                        
                        {/* Overlay Controls */}
                            <button
                                onClick={locateUser}
                                className="absolute bottom-6 right-4 z-[1000] bg-white p-3 rounded-full shadow-xl text-blue-600 hover:bg-blue-50 transition transform hover:scale-110"
                            title="התמקד על המיקום שלי"
                        >
                            <Icon name="crosshair" />
                        </button>

                        {/* Empty State Overlay */}
                        {polygon.length === 0 && (
                            <div className="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-lg border border-blue-100 text-xs font-bold text-slate-600 flex items-center gap-2 animate-bounce">
                                <span className="w-2 h-2 bg-blue-500 rounded-full"></span>
                                לחץ על המפה כדי להתחיל בסימון
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>